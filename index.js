const imgMaxSize=100;$(function(){function e(){var r=$("#categoryUrlTree");r.empty(),DAO.db.exeSql("SELECT a.id,a.name,a.desc,null img,b.num,'1' type,null img_type FROM categories a left join   (    select sup_id,count(1) num     from       (         select sup_id,1 num from categories where level = 2         union all         select cat_id,1 from urls      )     group by sup_id  ) b on a.id = b.sup_id WHERE a.level = 1 union all select c.id, c.name,c.addr desc,d. base_data img,0,'0' type,img_type from urls c left join icons d on c.img = d.id where c.cat_id = ''",[],a=>{log(a),a.forEach((t,e)=>{d(t,1,r,!1,a.length,e)})})}function t(){$("#caseSence").prop("checked")||!$("#hasChar").prop("checked")?($("#lowercase").prop("disabled",!0),$("#lowercase").next().addClass("disabled")):($("#lowercase").prop("disabled",!1),$("#lowercase").next().removeClass("disabled"))}function a(t,e,a){var r=$("<table></table>");r.css({width:"100%"});a=Form.generateForm([{label:InfoStr.categoryName,attr:{type:"text",id:"input-category-name"}},{label:InfoStr.catgoryDesc,attr:{type:"text",id:"input-category-description"}},{label:InfoStr.superCategory,attr:{type:"button",id:"button-super-category-select",value:t}},{label:InfoStr.superCategoryId,attr:{type:"hidden",id:"input-super-category-id",value:e}},{label:InfoStr.superCategoryLevel,attr:{type:"hidden",id:"input-super-category-level",value:a}}]);r.append(a),PopWin.show(InfoStr.newCategory,r,[new PopBtn(InfoStr.cancel,null,()=>{}),new PopBtn(InfoStr.add,LEVEL.SUCCESS,()=>{var a=$("#input-category-name").val(),r=$("#input-category-description").val(),o=$("#input-super-category-id").val();let n=$("#input-super-category-level").val();return n=""==n||""==o?"0":n,n=parseInt(n)+1,DAO.db.exeSql("SELECT 1 FROM categories WHERE name = ? and sup_id = ?",[a,o],t=>{var e;log(t),null==t||t.length<=0?(e={id:Math.uuidFast(),name:a,desc:r,sup_id:o,level:n,add_time:(new Date).getTime()},DAO.db.batInsert([e],"categories",()=>{Toast.show(formatString(InfoStr.categoryAddSucc,a),LEVEL.SUCCESS),PopWin.hide();var t=""==o?$("#categoryUrlTree"):$("#cat_"+o);""!=o&&"opened"!=t.attr("status")||(e.type="1",d(e,n,t,!0)),s(t,!0)},()=>{Toast.show(InfoStr.categoryAddFail,LEVEL.ERROR),PopWin.hide()})):Toast.show(InfoStr.categoryAlreadyExist,LEVEL.ERROR)},()=>{Toast.show(InfoStr.categoryCheckFail,LEVEL.ERROR)}),!1})])}function d(t,e,a,r,o,n){var l=$("<div class='sub-categories'></div>"),i=$("<div class='obj-area'></div>"),s=$("<img class='identifier-img' />"),d=$("<div class='url-img' style='float: left;display: none;'></div>"),c=$("<a class='open-obj' href='javascript:;'></a>"),p=$("<div class='oper-area'></div>"),u=$("<button class='delete-category error'>"+InfoStr.delete+"</button>"),g=$("<button class='update-category'>"+InfoStr.modify+"</button>"),f=$("<button class='copy-address'>"+InfoStr.copyAddr+"</button>"),m="1"==t.type?"cat":"url";l.attr("id",m+"_"+t.id),l.attr("obj_type",m),l.attr("obj_id",t.id),l.attr("level",""+e),l.attr("status","closed"),l.data("index",n),l.data("count",o),"url"==m?(t.img?"1"==t.img_type?s.attr("src",t.img):(s.css({display:"none"}),d.html(t.img),d.show()):s.attr("src","assets/url.png"),l.attr("url",t.desc),p.append([g,u,f])):(s.attr("src","assets/"+(0<t.num?"not_empty":"empty")+"_closed.png"),o=$("<button class='add-sub-category'>"+InfoStr.addSubCategory+"</button>"),f=$("<button class='add-url'>"+InfoStr.addUrl+"</button>"),p.append([g,o,f,u])),t.desc&&(s.attr("title",t.desc),d.attr("title",t.desc),c.attr("title",t.desc)),c.text(t.name),i.append(function(l,i,s,d){const c=[];for(let n=0;n<l;n++){let t=$("<div class='tree-tab'></div>"),e=$("<div class='tree-tab-left'></div>"),a=$("<div class='tree-tab-up'></div>"),r=$("<div class='tree-tab-right'></div>"),o=$("<div class='tree-tab-down'></div>");1==l||n,t.data("obj_id",s),t.data("index",i),t.data("level",d),t.append([e,a,o,r]),c.push(t)}return c}(e,n,t.id,e),[s,d,c,p]),l.append(i),"url"!=m&&r?l.insertAfter(a.find(".sub-categories[obj_type='cat']").last()):a.append(l),function(t){t.find(".sub-categories .show-line").removeClass("show-line");var e=parseInt(t.attr("level")),a=t.find(".sub-categories[level='"+(e+1)+"']");let r=h(t);for(var o=0;o<a.length;o++)for(var n=$(a.get(o)),l=n.find(".tree-tab"),i=0;i<l.length;i++){var s=$(l.get(i)),d=s.data("index"),c=s.data("level"),p=function(t){var e=null;t&&(0<t.prev().length?e=t.prev():(t=t.parent()).hasClass("sub-categories")&&(e=t));return e}(n);!p||(i!=c-1&&p.find(".obj-area:first-child").find(".tree-tab:nth-child("+i+")").find(".tree-tab-down").hasClass("show-line")||i==c-1&&(0!=e||0!=d))&&s.find(".tree-tab-up").addClass("show-line"),i+1==c&&s.find(".tree-tab-right").addClass("show-line");d=h(n);if(d)if(c!=parseInt(d.attr("level"))){let t=d.find(".obj-area:first-child"),e=t.find(".tree-tab:nth-child("+i+")");0<e.length&&e.find(".tree-tab-up").hasClass("show-line")&&s.find(".tree-tab-down").addClass("show-line")}else if(r&&i<c-1){let t=r.find(".obj-area:first-child"),e=t.find(".tree-tab:nth-child("+i+")");0<e.length&&e.find(".tree-tab-up").hasClass("show-line")&&s.find(".tree-tab-down").addClass("show-line")}else i==c-1&&s.find(".tree-tab-down").addClass("show-line")}}(a);const S=localStorage.getItem("opendCats")||"";0<=S.indexOf(t.id)&&c.trigger("click")}function h(t){var e=null;return t&&(0<t.next().length?e=t.next():(t=t.parent()).hasClass("sub-categories")&&(e=h(t))),e}function s(t,e){"categoryUrlTree"!=t.attr("id")&&(t=t.find("img").first(),e?t.attr("src").indexOf("not_empty")<0&&t.attr("src",t.attr("src").replace("empty","not_empty")):t.attr("src",t.attr("src").replace("not_","")))}function n(t,e,a){var r=$("<table class='url'></table>");r.css({width:"100%"});var o=$("<div id='img_url_container' class='url-img' style='float: left;'></div><img id='img-url' src='' /><span id='icon_list_container'></span><input type='button' id='add-img' value='"+InfoStr.uploadNewIcon+"' />"),a=Form.generateForm([{label:InfoStr.urlDesc,attr:{type:"text",id:"input-url-name"}},{label:InfoStr.url,attr:{type:"url",id:"input-url-addr",class:"url"}},{label:InfoStr.icon,attr:{type:"file",id:"input-file"},replaceEl:o},{label:"",replaceEl:$("<span style='color: red;'>&nbsp;"+formatString(InfoStr.imgTooLarge,imgMaxSize)+"</span>"),noColon:!0},{label:InfoStr.belongToCategory,attr:{type:"button",id:"button-super-category-select",value:t}},{label:InfoStr.belongCategoryId,attr:{type:"hidden",id:"input-super-category-id",value:e}},{label:InfoStr.belongCategoryLevel,attr:{type:"hidden",id:"input-super-category-level",value:a}},{label:InfoStr.imgType,attr:{type:"hidden",id:"input-img-type",value:"1"}}]);r.append(a),PopWin.show(InfoStr.newUrl,r,[new PopBtn(InfoStr.cancel,null,()=>{}),new PopBtn(InfoStr.add,LEVEL.SUCCESS,()=>{var a=$("#input-url-name").val(),r=$("#input-url-addr").val(),o=$("#input-super-category-id").val(),n=$("#input-super-category-level").val(),l=$("#input-img-type").val(),i=LxySelect.getValue("icon_list");return DAO.db.exeSql("SELECT 1 FROM urls WHERE cat_id = ? AND name = ?",[o,a],t=>{var e;log(t),null==t||t.length<=0?(e={id:Math.uuidFast(),name:a,addr:r,img:i,cat_id:o,add_time:(new Date).getTime()},DAO.db.batInsert([e],"urls",()=>{var t;Toast.show(formatString(InfoStr.urlAddSucc,a),LEVEL.SUCCESS),e.type="0",e.desc=r,e.img="1"==l?$("#img-url").attr("src"):$("#img_url_container").html(),e.img_type=l,PopWin.hide(),""==o?d(e,1,$("#categoryUrlTree")):("opened"==(t=$("#cat_"+o)).attr("status")&&d(e,parseInt(n)+1,t),s(t,!0))},()=>{Toast.show(InfoStr.urlAddFail,LEVEL.ERROR),PopWin.hide()})):Toast.show(InfoStr.urlAlreadyExist,LEVEL.ERROR)},(t,e)=>{err(e),Toast.show(InfoStr.urlCheckFail,LEVEL.ERROR)}),!1})],()=>{DAO.db.exeSql("SELECT id, img_type, base_data, desc FROM icons",[],t=>{const e=[];t.forEach(t=>{e.push({prefix:1==t.img_type?$("<img class='url-img' src='"+t.base_data+"' />"):$(t.base_data),text:t.desc,value:t.id})}),new LxySelect({selectId:"icon_list",data:e,onselected:t=>{log(t),"IMG"==$(t.prefix)[0].tagName?($("#img-url").attr("src",$(t.prefix).attr("src")),$("#img_url_container").hide(),$("#img-url").show(),$("#input-img-type").val("1")):($("#img_url_container").html(t.prefix),$("#img_url_container").show(),$("#img-url").hide(),$("#input-img-type").val("2"))}},$("#icon_list_container")),LxySelect.setValue("icon_list","1"),$("#img-url").attr("src",$(LxySelect.getSelectedOption("icon_list").prefix).attr("src"))},()=>{Toast.show(InfoStr.iconQueryFail,LEVEL.ERROR),PopWin.hide(1)})})}function c(t){let e=localStorage.getItem("opendCats")||"";0<=e.indexOf(t)&&localStorage.setItem("opendCats",e.replace(t+",",""))}function o(r,o,n){DAO.db.exeSql("SELECT 1 FROM icons WHERE base_data = ?",[r],t=>{var e,a;0<t.length?Toast.show(InfoStr.iconExists,LEVEL.ERROR):(e=()=>{var t=Math.uuidFast(),e=$("#input-icon-desc").val();return DAO.db.batInsert([{id:t,img_type:o,base_data:r,desc:e,add_time:(new Date).getTime()}],"icons",()=>{Toast.show(InfoStr.iconAddSucc,LEVEL.SUCCESS),PopWin.hide(1),n&&n(t,e)},()=>{Toast.show(InfoStr.iconAddFail,LEVEL.ERROR)}),!1},(a=$("<table></table>")).css({width:"100%"}),t=Form.generateForm([{label:InfoStr.icon,attr:{type:"text",id:"input-img-src"},replaceEl:1==o?$("<img class='url-img' src='"+r+"' />"):$(r)},{label:InfoStr.desc,attr:{type:"text",id:"input-icon-desc"},enterFn:e}]),a.append(t),PopWin.show(InfoStr.iconDesc,a,[new PopBtn(InfoStr.cancel,null,()=>{}),new PopBtn(InfoStr.save,LEVEL.SUCCESS,e)],()=>{$("#input-icon-desc").trigger("focus")},!0))},()=>{Toast.show(InfoStr.iconValidateFail,LEVEL.ERROR)})}$("#categoryUrlTree").on("click",".open-obj,.identifier-img",t=>{var r=$(t.target).parent().parent(),t=r.attr("obj_type"),e=r.attr("obj_id");if("cat"==t){var a=r.attr("status"),o=r.find(".identifier-img").first();if("closed"==a){var n=parseInt(r.attr("level"))+1;DAO.db.exeSql("SELECT a.id,a.name,a.desc,null img,b.num,'1' type,null img_type FROM categories a left join (   select sup_id,count(1) num   from      (       select sup_id,1 num from categories where level = ?       union all       select cat_id,1 from urls      )   group by sup_id ) b on a.id = b.sup_id WHERE a.level = ? and a.sup_id = ? union all select c.id, c.name,c.addr desc,d.base_data img,0,'0' type,img_type from urls c left join icons d on c.img = d.id where c.cat_id = ?",[n+1,n,e,e],a=>{log(a),a.forEach((t,e)=>{d(t,n,r,!1,a.length,e)}),r.attr("status","opened"),o.attr("src",o.attr("src").replace("closed","opened")),function(t){let e=localStorage.getItem("opendCats")||"";e.indexOf(t)<0&&(e+=t+",",localStorage.setItem("opendCats",e))}(e)})}else{const l=r.find(".sub-categories");log(l);for(let t=0;t<l.length;t++){const i=$(l.get(t));"opened"==i.attr("status")&&(log(i),c(i.attr("obj_id")))}r.find(".sub-categories").remove(),r.attr("status","closed"),o.attr("src",o.attr("src").replace("opened","closed")),c(e)}}else{a=r.attr("url");if(a.startsWith("file")&&!location.protocol.startsWith("file")){const s=$('<input id="input_temp" type="hidden" />');s.val(a),s.appendTo($("body")),document.execCommand("copy")}else window.open(a)}}),$("#categoryUrlTree").on("click",".copy-address",t=>{log(t);t=$(t.target).parent().parent().parent().attr("url");log(t);const e=$('<input id="input_temp" type="hidden" />');e.val(t),e.appendTo($("body")),document.execCommand("copy")}),$("#categoryUrlTree").on("click",".delete-category",t=>{log(t.target);const e=$(t.target).parent().parent().parent();log(e);const r=e.parent();var o=e.attr("obj_type"),n=e.attr("obj_id"),l=e.find("a").first().text(),i="cat"==o?InfoStr.category:InfoStr.url;PopWin.show(InfoStr.delete+i,formatString(InfoStr.deleteDesc,[i,l]),[new PopBtn(InfoStr.cancel,null,()=>{}),new PopBtn(InfoStr.delete,LEVEL.ERROR,()=>{var e,a;"cat"==o?(log(l),a=1,(e=[]).push(n),function a(t,e,r){DAO.db.exeSql("SELECT id, name FROM categories WHERE sup_id = ?",[t],t=>{r(t),t&&0<t.length&&t.forEach((t,e)=>{log(t.name),a(t.id,t.name,r)})},()=>{Toast.show(InfoStr.category+" "+InfoStr.quota1+e+InfoStr.quota2+" "+InfoStr.query+InfoStr.fail,LEVEL.ERROR)})}(n,l,t=>{a--,t&&0<t.length&&(a+=t.length,t.forEach(t=>{e.push(t.id)})),0==a&&DAO.db.exeSql("DELETE FROM urls WHERE cat_id in ?",[e],()=>{DAO.db.exeSql("DELETE FROM categories WHERE id in ?",[e],()=>{Toast.show(formatString(InfoStr.deleteSucc,[i,l]),LEVEL.SUCCESS),$("#cat_"+n).remove(),s(r,0<r.find(".sub-categories").length)},()=>{Toast.show(formatString(InfoStr.deleteFail,[i,l]),LEVEL.ERROR)})},()=>{Toast.show(InfoStr.urlDelFailUnderCat,LEVEL.ERROR)})})):DAO.db.exeSql("DELETE FROM urls WHERE id = ?",[n],()=>{Toast.show(formatString(InfoStr.deleteSucc,[i,l]),LEVEL.SUCCESS),$("#url_"+n).remove(),s(r,0<r.find(".sub-categories").length)},()=>{Toast.show(formatString(InfoStr.deleteFail,[i,l]),LEVEL.ERROR)})})])}),$("#categoryUrlTree").on("click",".update-category",t=>{log(t.target);const o=$(t.target).parent().parent().parent();var t=o.attr("obj_type"),l=o.attr("obj_id");"cat"==t?DAO.db.exeSql("SELECT id,name,desc,sup_id,level FROM categories WHERE id = ?",[l],t=>{var r,e;log(t),t&&0<t.length&&(r=t[0],(e=$("<table></table>")).css({width:"100%"}),t=function(){let e="",a=o.parents(".sub-categories");for(let t=a.length-1;0<=t;t--)e+=$(a[t]).find("a").first().text(),0<t&&(e+=" >> ");return e}(),t=Form.generateForm([{label:InfoStr.categoryId,attr:{type:"hidden",id:"input-category-id",value:l}},{label:InfoStr.categoryName,attr:{type:"text",id:"input-category-name",value:r.name}},{label:InfoStr.catgoryDesc,attr:{type:"text",id:"input-category-description",value:r.desc}},{label:InfoStr.superCategory,attr:{type:"text",readOnly:"readOnly",value:""==t?InfoStr.topLevel:t}}]),e.append(t),PopWin.show(InfoStr.modifyCategory,e,[new PopBtn(InfoStr.cancel,null,()=>{}),new PopBtn(InfoStr.save,LEVEL.SUCCESS,()=>{var e=$("#input-category-name").val(),a=$("#input-category-description").val();return DAO.db.exeSql("SELECT 1 FROM categories WHERE name = ? and sup_id = ? and id != ?",[e,r.sup_id,l],t=>{log(t),null==t||t.length<=0?DAO.db.exeSql("UPDATE categories set name = ? , desc = ? WHERE id = ?",[e,a,l],()=>{Toast.show(InfoStr.categoryModifySucc,LEVEL.SUCCESS),$("#cat_"+l).find("a").first().text(e),$("#cat_"+l+" .obj-area:nth(0) img,#cat_"+l+" .obj-area:nth(0) a").attr("title",a),PopWin.hide()},()=>{Toast.show(InfoStr.categoryModifyFail,LEVEL.ERROR)}):Toast.show(InfoStr.categoryAlreadyExist,LEVEL.ERROR)},()=>{Toast.show(InfoStr.categoryCheckFail,LEVEL.ERROR)}),!1})]))},()=>{Toast.show(InfoStr.categoryGetFail,LEVEL.ERROR)}):DAO.db.exeSql("SELECT a.id,a.name,a.addr,a.img img_id,b.base_data img,a.cat_id,b.img_type FROM urls a left join icons b on a.img = b.id WHERE a.id = ?",[l],t=>{var n,e,a;log(t),t&&0<t.length&&(n=t[0],(e=$("<table class='url'></table>")).css({width:"100%"}),a=function(){let e="",a=o.parents(".sub-categories");for(let t=a.length-1;0<=t;t--)e+=$(a[t]).find("a").first().text(),0<t&&(e+=" >> ");return e}(),t=$("<div id='img_url_container' class='url-img' style='float: left;"+("1"==n.img_type?"display:none;'></div>":"'>"+n.img+"</div>")+"</div><img id='img-url' "+("1"==n.img_type?"src='"+(n.img||url_img_str)+"'":"style='display:none;'")+" /><span id='icon_list_container'></span><input type='button' id='add-img' value='"+InfoStr.uploadNewIcon+"' />"),a=Form.generateForm([{label:InfoStr.urlId,attr:{type:"hidden",id:"input-url-id",value:l}},{label:InfoStr.urlDesc,attr:{type:"text",id:"input-url-name",value:n.name}},{label:InfoStr.url,attr:{type:"url",id:"input-url-description",value:n.addr}},{label:InfoStr.icon,attr:{type:"file",id:"input-file"},replaceEl:t},{label:"",replaceEl:$("<span style='color: red;'>&nbsp;"+formatString(InfoStr.imgTooLarge,imgMaxSize)+"</span>"),noColon:!0},{label:InfoStr.belongToCategory,attr:{type:"text",readOnly:"readOnly",value:""==a?InfoStr.topLevel:a}},{label:InfoStr.imgType,attr:{type:"hidden",id:"input-img-type",value:n.img_type}}]),e.append(a),PopWin.show(InfoStr.modifyUrl,e,[new PopBtn(InfoStr.cancel,null,()=>{}),new PopBtn(InfoStr.save,LEVEL.SUCCESS,()=>{var e=$("#input-url-name").val(),a=$("#input-url-description").val(),r=LxySelect.getValue("icon_list"),o=$("#input-img-type").val();return DAO.db.exeSql("SELECT 1 FROM urls WHERE cat_id = ? AND name = ? and id != ?",[n.cat_id,e,l],t=>{log(t),null==t||t.length<=0?DAO.db.exeSql("UPDATE urls set name = ?, addr = ?, img = ? WHERE id = ?",[e,a,r,l],()=>{Toast.show(InfoStr.urlModifySucc,LEVEL.SUCCESS),$("#url_"+l).find("a").first().text(e),"1"==o?($("#url_"+l).find("img").attr("src",$("#img-url").attr("src")),$("#url_"+l).find(".url-img").hide(),$("#url_"+l).find("img").show()):($("#url_"+l).find(".url-img").html($("#img_url_container").html()),$("#url_"+l).find("img").hide(),$("#url_"+l).find(".url-img").show()),PopWin.hide(),$("#url_"+l+" img,#url_"+l+" a").attr("url",a).attr("title",a)},()=>{Toast.show(InfoStr.urlModifyFail,LEVEL.ERROR)}):Toast.show(InfoStr.urlAlreadyExist,LEVEL.ERROR)},(t,e)=>{err(e),Toast.show(InfoStr.urlAlreadyExist,LEVEL.ERROR)}),!1})],()=>{DAO.db.exeSql("SELECT id, base_data, desc,img_type FROM icons",[],t=>{const e=[];t.forEach(t=>{e.push({prefix:1==t.img_type?$("<img class='url-img' src='"+t.base_data+"' />"):$(t.base_data),text:t.desc,value:t.id})}),new LxySelect({selectId:"icon_list",data:e,onselected:t=>{log(t),"IMG"==$(t.prefix)[0].tagName?($("#img-url").attr("src",$(t.prefix).attr("src")),$("#img_url_container").hide(),$("#img-url").show(),$("#input-img-type").val("1")):($("#img_url_container").html(t.prefix),$("#img_url_container").show(),$("#img-url").hide(),$("#input-img-type").val("2"))}},$("#icon_list_container")),LxySelect.setValue("icon_list",n.img_id)},()=>{Toast.show(InfoStr.iconQueryFail,LEVEL.ERROR),PopWin.hide(1)})}))},()=>{Toast.show(InfoStr.urlGetFail,LEVEL.ERROR)})}),$("#categoriesList").on("click",".delete-category",t=>{log(t.target);const e=$(t.target);var a=e.attr("cat_id"),r=$("#cat_"+a).find(".category-name").text();PopWin.show("删除类别","您确认要删除类别 “"+r+"” 吗？",[new PopBtn("取消",null,()=>{}),new PopBtn("删除",LEVEL.ERROR,()=>{DAO.db.exeSql("DELETE FROM categories WHERE id = ?",[a],()=>{var c;Toast.show("类别 “"+r+"” 删除成功",LEVEL.SUCCESS),(c=$("#categoriesList")).empty(),DAO.db.exeSql("SELECT a.id,a.name,a.desc,a.sup_id,a.add_time,b.name sup_name FROM categories a LEFT JOIN categories b ON a.sup_id = b.id",[],t=>{log(t),t.forEach((t,e)=>{var a=$("<tr></tr>"),r=$("<td class='center'></td>"),o=$("<td class='category-name'></td>"),n=$("<td></td>"),l=$("<td></td>"),i=$("<td class='center'></td>"),s=$("<td class='center'></td>"),d=$("<button class='delete-category error'>"+InfoStr.delete+"</button>");a.attr("id","cat_"+t.id),r.text(e+1),o.text(t.name),n.text(t.desc),l.text(t.sup_name),i.text(new Date(t.add_time).format("yyyy-MM-dd hh:mm:ss")),d.attr("cat_id",t.id),s.append(d),a.append([r,o,n,l,i,s]),c.append(a)})})},()=>{Toast.show("类别 “"+r+"” 删除失败",LEVEL.ERROR)})})])}),$("#hasChar").on("change",()=>{$("#hasChar").prop("checked")?($("#caseSence").prop("disabled",!1),$("#caseSence").next().removeClass("disabled")):($("#caseSence").prop("disabled",!0),$("#caseSence").next().addClass("disabled")),t()}),$("#caseSence").on("change",t),$("#caseSence").on("change",t),$("#generatePassword").on("click",()=>{var t=parseInt($("#passwordLength").val()),e=$("#hasNum").prop("checked"),a=$("#hasChar").prop("checked"),r=$("#hasSymbol").prop("checked"),o=$("#caseSence").prop("checked"),n=$("#lowercase").prop("checked"),l=$("#blankSpace").prop("checked"),i=genEnCode(t,e,a,r,o,n,!l);if(null!=i){$("#password").val(i);const s=$('<input id="input_tmp" type="hidden" />');s.val(i),s.appendTo($("body")),document.execCommand("copy"),localStorage.setItem("hasNum",e?"1":"0"),localStorage.setItem("hasChar",a?"1":"0"),localStorage.setItem("hasSymbol",r?"1":"0"),localStorage.setItem("caseSence",o?"1":"0"),localStorage.setItem("lowercase",n?"1":"0"),localStorage.setItem("blankSpace",l?"1":"0"),localStorage.setItem("passwordLength",t)}else Toast.show(InfoStr.passwordConfigError,LEVEL.ERROR)}),$("#openAddCategoryWindow").on("click",()=>{a(InfoStr.selectSuperCategory,"","")}),$("body").on("click","#button-super-category-select",()=>{$(".menu-area").remove(),DAO.db.exeSql("SELECT a.id,a.name,a.desc,b.num FROM categories a left join (select sup_id,count(1) num from categories where level = 2 group by sup_id) b on a.id = b.sup_id WHERE a.level = 1",[],t=>{var e,o,a,r,n;log(t),null!=t&&0<t.length&&(e=$("#button-super-category-select"),(o=$("<div></div>")).addClass("menu-area level-1"),o.attr("level",1),a=$("<div></div>"),r=$("<div></div>"),n=$("<div></div>"),r.text(InfoStr.none),r.addClass("text"),n.text(""),n.addClass("right"),a.append([r,n]),a.addClass("menu"),a.attr("menu_id",""),a.attr("level",1),a.attr("path",InfoStr.none),o.append(a),t.forEach(t=>{var e=$("<div></div>"),a=$("<div></div>"),r=$("<div></div>");a.text(t.name),a.addClass("text"),r.text(t.num?">":""),r.addClass("right"),e.append([a,r]),e.addClass("menu"+(t.num?" has-next":"")),e.attr("menu_id",t.id),e.attr("level",1),e.attr("path",t.name),o.append(e)}),$("body").append(o),o.css({position:"absolute",top:e.offset().top+e.outerHeight()+"px",left:e.offset().left+"px"}))},()=>{Toast.show("查询类别失败",LEVEL.ERROR)})}),$("body").on("click",".menu",t=>{t=$(t.target);t.hasClass("menu")||(t=t.parent()),log(t[0]),$("#button-super-category-select").val(t.attr("path")),$("#input-super-category-id").val(t.attr("menu_id")),$("#input-super-category-level").val(t.attr("level"))}),$(document).on("click",t=>{"button-super-category-select"!=$(t.target).attr("id")&&$(".menu-area").remove()}),$("body").on("mouseenter",".menu",t=>{var a=$(t.target);a.hasClass("has-next")||(a=a.parent());var r,l=parseInt(a.attr("level"))+1;log(".level-"+l),$(".level-"+l).remove(),a.hasClass("has-next")&&(log(a[0]),r=a.attr("menu_id"),DAO.db.exeSql("SELECT a.id,a.name,a.desc,b.num FROM categories a left join (select sup_id,count(1) num from categories where level = ? group by sup_id) b on a.id = b.sup_id WHERE a.sup_id = ?",[l+1,r],t=>{var e,o,n;log(t),null!=t&&0<t.length&&(e=function(){for(var t="",e=1;e<=l;e++)t+=" level-"+e;return t}(),(o=$("<div></div>")).addClass("menu-area "+e),o.attr("for",r),o.attr("level",l),n=a.attr("path"),t.forEach(t=>{var e=$("<div></div>"),a=$("<div></div>"),r=$("<div></div>");a.text(t.name),a.addClass("text"),r.text(t.num?">":""),r.addClass("right"),e.append([a,r]),e.addClass("menu"+(t.num?" has-next":"")),e.attr("menu_id",t.id),e.attr("level",l),e.attr("path",n+(""==n?"":" >> ")+t.name),o.append(e)}),$("body").append(o),o.css({position:"absolute",top:a.offset().top+"px",left:a.offset().left+a.outerWidth()+"px"}))}))}),$("#categoryUrlTree").on("click",".add-sub-category",t=>{log(t.target);const r=$(t.target).parent().parent().parent();var e=r.attr("obj_id"),o=r.find("a").first().text(),t=r.attr("level");a(function(){let e="",a=r.parents(".sub-categories");for(let t=a.length-1;0<=t;t--)e+=$(a[t]).find("a").first().text(),0<t&&(e+=" >> ");return e+=(""==e?"":" >> ")+o,e}(),e,t)}),$("#categoryUrlTree").on("click",".add-url",t=>{log(t.target);const r=$(t.target).parent().parent().parent();log(r);var e=r.attr("obj_id"),o=r.find("a").first().text(),t=r.attr("level");n(function(){let e="",a=r.parents(".sub-categories");for(let t=a.length-1;0<=t;t--)e+=$(a[t]).find("a").first().text(),0<t&&(e+=" >> ");return e+=(""==e?"":" >> ")+o,e}(),e,t)}),$("body").on("click","#add-img",()=>{$("#input-file").trigger("click")}),$("body").on("click","#reset-img",()=>{$("#img-url").attr("src",url_img_str)}),$("#openAddUrlWindow").on("click",()=>{n(InfoStr.belongToCategory,"","")}),$("#openExportDataWindow").on("click",()=>{var t=$("<textarea id='sqlData'></textarea>");PopWin.show(InfoStr.ExportData,t,[new PopBtn(InfoStr.close,null,()=>{})],()=>{DAO.getEveryData(t=>{$("#sqlData").val($("#sqlData").val()+t+";\n")})})}),$("#export_sql_file").on("click",()=>{DAO.getAllData(t=>{var e,a;e="ToolsAndUrls.sql",a=t,(t=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(a)),t.setAttribute("download",e),document.createEvent?((e=document.createEvent("MouseEvents")).initEvent("click",!0,!0),t.dispatchEvent(e)):t.click()})}),$("#openImportDataWindow").on("click",()=>{var t=$("<table><tr style='color:red;'><td>"+InfoStr.importAttention+"</td></tr><tr><td><textarea id='sqlData' style='width: 100%;'></textarea></td></tr><tr><td><input type=\"button\" value=\""+InfoStr.chooseFile+'" id="btn_choose_file" /><input type="file" id="file_select" style="display: none;" /></td></tr></table>');PopWin.show(InfoStr.ImportData,t,[new PopBtn(InfoStr.cancel,null,()=>{}),new PopBtn(InfoStr.import,LEVEL.SUCCESS,()=>{const t=$("#sqlData").val("opendCats");return DAO.db.batchExecute(["DELETE FROM categories","DELETE FROM urls","DELETE FROM icons"],()=>{localStorage.removeItem(""),DAO.db.batchExecute(t.split(";\n"),()=>{Toast.show(InfoStr.importSucc,LEVEL.SUCCESS),PopWin.hide(),e()},(t,e)=>{log(e),Toast.show(InfoStr.importFail,LEVEL.ERROR)})},()=>{Toast.show(InfoStr.importCleanFail,LEVEL.ERROR)}),!1})],()=>{$("#btn_choose_file").on("click",()=>{$("#file_select").trigger("click")}),$("#file_select").on("change",t=>{log(t);var e=$(t.target).get(0).files;e&&0<e.length&&(t=e[0],window.FileReader&&((e=new FileReader).onloadend=function(t){t.target.readyState==FileReader.DONE&&(t=t.target.result,$("#sqlData").val(t))},e.readAsText(t)))})})}),$("body").on("change","#input-file",r=>{if(0<r.target.files.length){var t=r.target.files[0];log(t);const e=new FileReader;e.onload=function(t){const a=new Image;a.onload=function(){var t=this.width,e=this.height;t>imgMaxSize||e>imgMaxSize?Toast.show(formatString(InfoStr.imgTooLarge,imgMaxSize),LEVEL.ERROR):o(a.src,1,(t,e)=>{LxySelect.addOption("icon_list",{prefix:$("<img class='url-img' src='"+a.src+"' />"),text:e,value:t})}),$(r.target).val("")},a.onerror=t=>{log(t)},a.src=t.target.result},e.onerror=t=>{log(t)},e.onabort=()=>{},e.onloadstart=()=>{},e.onprogress=()=>{},e.readAsDataURL(t)}}),function(){for(var t=$("[infoStr]"),e=0;e<t.length;e++){var a=$(t.get(e));a.text(InfoStr[a.attr("infoStr")]),a.val(InfoStr[a.attr("infoStr")])}}(),$("#passwordLength").val(localStorage.getItem("passwordLength")||16),$("#hasNum").prop("checked","1"==localStorage.getItem("hasNum")),$("#hasChar").prop("checked","1"==localStorage.getItem("hasChar")),$("#hasSymbol").prop("checked","1"==localStorage.getItem("hasSymbol")),$("#caseSence").prop("checked","1"==localStorage.getItem("caseSence")),$("#lowercase").prop("checked","1"==localStorage.getItem("lowercase")),$("#blankSpace").prop("checked","1"==localStorage.getItem("blankSpace")),$("#hasChar").prop("checked")?($("#caseSence").prop("disabled",!1),$("#caseSence").next().removeClass("disabled"),$("#caseSence").prop("checked")?($("#lowercase").prop("disabled",!0),$("#lowercase").next().addClass("disabled")):($("#lowercase").prop("disabled",!1),$("#lowercase").next().removeClass("disabled"))):($("#caseSence").prop("disabled",!0),$("#caseSence").next().addClass("disabled"),$("#lowercase").prop("disabled",!0),$("#lowercase").next().addClass("disabled")),DAO.init(),e(),$("body").on("copy",t=>{0<$("#input_temp").length&&(t.preventDefault(),t.originalEvent&&t.originalEvent.clipboardData?(t.originalEvent.clipboardData.setData("text/plain",$("#input_temp").val()),Toast.show(InfoStr.urlCopied)):PopWin.show(InfoStr.url,$("#input_temp").val(),[new PopBtn(InfoStr.close)]),$("#input_temp").remove()),0<$("#input_tmp").length&&(t.preventDefault(),t.originalEvent&&t.originalEvent.clipboardData?(t.originalEvent.clipboardData.setData("text/plain",$("#input_tmp").val()),Toast.show(InfoStr.passwordCopied)):(log(InfoStr.pass+$("#input_tmp").val()),Toast.show(InfoStr.passwordPrinted)),$("#input_tmp").remove())}),$("#openIconWindow").on("click",()=>{const a=$('<table><tr><td><select id=\'icon_list\'></select></td></tr><tr><td><input type="file" id="input_icon_add" class="hidden" /></td></tr><tr><td><input type="button" value="'+InfoStr.add+'" id="btn_add_icon" /><input type="button" value="'+InfoStr.addHtmlImg+'" id="btn_add_html_icon" /><input type="button" value="'+InfoStr.delete+'" id="btn_del_icon" /></td></tr></table>');PopWin.show(InfoStr.iconManagement,a,[new PopBtn(InfoStr.close,null,()=>{})],()=>{DAO.db.exeSql("select id, img_type, base_data, desc, sort_key from icons",[],t=>{const e=[];t.forEach(t=>{e.push({value:t.id,html:1==t.img_type?"<img class='url-img' src=\""+t.base_data+'" /> '+t.desc:"<div class='url-img' style='float: left;'>"+t.base_data+"</div> "+t.desc,text:t.desc})});t=new ListBox("icon_list",{options:e});$("#icon_list").data("icon_list",t),a.find(".list").css({maxHeight:.8*$(window).height()-80-20-10+"px"})})})}),$("body").on("click","#btn_add_icon",()=>{$("#input_icon_add").trigger("click")}),$("body").on("click","#btn_add_html_icon",()=>{var t=$("<div><textarea id='html_icon_str' style='width: 100%;'></textarea></div>");PopWin.show(InfoStr.addHtmlImg,t,[new PopBtn(InfoStr.cancel,null,()=>{}),new PopBtn(InfoStr.confirm,LEVEL.SUCCESS,()=>{var r=$("#html_icon_str").val().trim();return""!=r&&o(r,2,(t,e)=>{const a=$("#icon_list").data("icon_list");a.addOption({value:t,text:e,html:r+" "+e})}),!1})],null,!0)}),$("body").on("change","#input_icon_add",a=>{if(0<a.target.files.length){var t=a.target.files[0];const e=new FileReader;e.onload=function(t){const r=new Image;r.onload=function(){var t=this.width,e=this.height;t>imgMaxSize||e>imgMaxSize?Toast.show(formatString(InfoStr.imgTooLarge,imgMaxSize),LEVEL.ERROR):o(r.src,1,(t,e)=>{const a=$("#icon_list").data("icon_list");a.addOption({value:t,text:e,html:"<img class='url-img' src=\""+r.src+'" /> '+e})}),$(a.target).val("")},r.onerror=t=>{log(t)},r.src=t.target.result},e.onerror=t=>{log(t)},e.onabort=()=>{},e.onloadstart=()=>{},e.onprogress=()=>{},e.readAsDataURL(t)}}),$("body").on("click","#btn_del_icon",()=>{const a=$("#icon_list").data("icon_list");var r=a.getSelectedOption();"1"==r.value?Toast.show(InfoStr.iconCannotDeleteDefault,LEVEL.ERROR):DAO.db.exeSql("SELECT COUNT(1) num FROM urls where img = ?",[r.value],t=>{let e="";null!=t&&0<t.length&&0<t[0].num&&(e=formatString(InfoStr.iconUsedDesc,t[0].num)),PopWin.show(InfoStr.delete+InfoStr.icon,e+InfoStr.iconDeleteClP1+r.html+InfoStr.iconDeleteClP2,[new PopBtn(InfoStr.cancel,null,()=>{}),new PopBtn(InfoStr.confirm,LEVEL.ERROR,()=>{DAO.db.exeSql("DELETE FROM icons WHERE id = ?",[r.value],()=>{Toast.show(InfoStr.icon+" "+r.html+InfoStr.iconDelSuccP2,LEVEL.SUCCESS),a.deleteSelected()},()=>{Toast.show(InfoStr.iconDelFailP1+r.html+InfoStr.iconDelFailP2,LEVEL.ERROR)})})],null,!0)},()=>{})})});